name: 3.🌟发布 正式版

on:
    # 每当 push 到 main 分支时触发部署
    push:
        tags:
            - "v[0-9]*.[0-9]*.[0-9][0-9]"
    # 手动触发部署
    workflow_dispatch:

jobs:
    # 调用上游 reusable workflow
    release-buildDocker:
        uses: LoveCards/LoveCardsV2/.github/workflows/release-buildDocker.yml@dev

    Build_Release:
        name: 🌟 发布正式版
        needs: release-buildDocker # 等上游跑完
        runs-on: ubuntu-latest
        env:
            commit_sha: ${{ github.sha }}
            release_buildDocker_file_name: lovecards-web-frankenphp
            release_buildWeb_file_name: LoveCardsV2

        steps:
            - name: 🏡 拉取代码
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: 📥 获取项目压缩包
              uses: actions/download-artifact@v4
              with:
                  name: ${{env.release_buildWeb_file_name}}
                  path: ./tmp/

            - name: 📥 获取Docker(frankenphp)镜像
              uses: actions/download-artifact@v4
              with:
                  name: ${{env.release_buildDocker_file_name}}
                  path: ./tmp/

            - name: 🎅 创建发布并上传压缩包
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  tag_name: ${{ github.ref_name }} # 创建Tag
                  name: ${{ github.ref_name }} # 发布名称
                  body_path: RELEASE.txt # 发布说明
                  draft: false # 是否为草稿
                  prerelease: true # 是否为预发布
                  files: |
                      ./tmp/${{env.release_buildDocker_file_name}}.zip
                      ./tmp/${{env.release_buildWeb_file_name}}.zip
                      LICENSE
              env:
                  # @see https://docs.github.com/cn/actions/reference/authentication-in-a-workflow#about-the-github_token-secret
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
