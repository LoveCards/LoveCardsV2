name: dev

on:
  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:

jobs:
  Dev:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ¡æ‹‰å–ä»£ç 
        uses: actions/checkout@v3
        with:
          # â€œæœ€è¿‘æ›´æ–°æ—¶é—´â€ ç­‰ git æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œéœ€è¦æ‹‰å–å…¨éƒ¨æäº¤è®°å½•
          fetch-depth: 0

      - name: ğŸ’¾ç¼“å­˜ Composer ä¾èµ–
        uses: actions/cache@v3
        with:
          path: /tmp/composer-cache
          key: ${{ runner.os }}-${{ hashFiles('**/composer.lock') }}

      - name: ğŸ› ï¸å®‰è£…ä¾èµ–
        uses: php-actions/composer@v6
        with:
          php_version: "8.1"
          version: 2

      # 1. æ‹¿åˆ°æœ€æ–° release çš„ tag å’Œä¸‹è½½ URL
      - name: ğŸ”è·å–æœ€æ–° release
        id: get_release
        run: |
          # ç”¨ gh release view ç›´æ¥è§£æ JSON
          read tag url <<< $(gh release view \
            --repo LoveCards/v2_frontend_admin \
            --json tagName,assets \
            --jq '
              (.tagName) + " " +
              (.assets[] | select(.name | test("admin-v\\..*\\.zip$")) | .url)
            ')
          echo "tag=$tag"     >> $GITHUB_OUTPUT
          echo "zip_url=$url" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      # 2. ä¸‹è½½å¹¶è§£å‹åˆ° ./public
      - name: ğŸ“¥ä¸‹è½½ admin-v1.x.x.zip
        run: |
          mkdir -p public
          curl -L -o admin.zip ${{ steps.get_release.outputs.zip_url }}
          unzip -q admin.zip -d public
          rm admin.zip

      - name: âŒåˆ é™¤éå¿…è¦æ–‡ä»¶
        run: |
          rm -rf .gitignore .github .dev ToDo.md .git DOCKER_ENV docker_tag output.log composer.json composer.lock script lock.txt upload.md test.env

      - name: ğŸ·ï¸è®¾ç½®å‹ç¼©åŒ…åç§°
        id: set_zip_name
        run: echo "zip_name=LoveCardsDev-${commit_sha}.zip" >> $GITHUB_OUTPUT

      - name: ğŸ“¦å‹ç¼©ä¸ºzip
        run: zip -r ${{ steps.set_zip_name.outputs.zip_name }} ./

      - name: ğŸš€ä¸Šä¼ Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set_zip_name.outputs.zip_name }}
          path: ${{ steps.set_zip_name.outputs.zip_name }}
          if-no-files-found: error