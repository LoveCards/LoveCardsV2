name: 2.ğŸ³æ„å»º Docker é•œåƒ (FrankenPHP)

on:
    # å…è®¸è¢«å…¶ä»–ä»“åº“è°ƒç”¨
    workflow_call:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    workflow_dispatch:

jobs:
    # è°ƒç”¨ä¸Šæ¸¸ reusable workflow
    release_buildWeb:
        uses: LoveCards/LoveCardsV2/.github/workflows/release-buildWeb.yml@dev

    release_buildDocker:
        name: ğŸ› ï¸ æ„å»º Docker é•œåƒ
        needs: release_buildWeb # ç­‰ä¸Šæ¸¸è·‘å®Œ
        runs-on: ubuntu-latest
        env:
            commit_sha: ${{ github.sha }}
            docker_name: lovecards-web-frankenphp
            release_buildWeb_file_name: LoveCardsV2

        steps:
            - name: ğŸ¡ æ‹‰å–ä»£ç 
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: ğŸ”§ è®¾ç½® Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: ğŸ“¥ è·å–é¡¹ç›®ä¸»ä½“å‹ç¼©åŒ…
              uses: actions/download-artifact@v4
              with:
                  name: ${{env.release_buildWeb_file_name}} # ä¸ä¸Šæ¸¸ upload-artifact çš„ name ä¸€è‡´
                  path: ./tmp

            - name: ğŸ”“ è§£å‹é¡¹ç›®å¹¶ç§»å…¥æ‰€éœ€é…ç½®
              run: |
                  unzip -q ./tmp/${{env.release_buildWeb_file_name}}.zip -d ./tmp
                  mv ./.docker/frankenphp/Dockerfile ./tmp
                  mv ./.frankenphp/Caddyfile ./tmp

            - name: ğŸ“¥ ç¼“å­˜ Docker å±‚
              uses: actions/cache@v4
              with:
                  path: /tmp/.buildx-cache
                  key: ${{ runner.os }}-buildx-${{ hashFiles('tmp/Dockerfile') }}
                  restore-keys: |
                      ${{ runner.os }}-buildx-

            - name: ğŸ³ æ„å»ºé•œåƒ
              id: docker-build
              run: |
                  mkdir -p ./tmp/a/image
                  docker buildx build \
                    --tag ${{env.docker_name}}:latest \
                    --cache-from=type=local,src=/tmp/.buildx-cache \
                    --cache-to=type=local,dest=/tmp/.buildx-cache,mode=max \
                    --load \
                    ./tmp

            - name: ğŸ—œï¸ å¯¼å‡ºé•œåƒ
              run: |
                  docker save ${{env.docker_name}}:latest | pigz -9 > ./tmp/a/image/${{env.docker_name}}.tar.gz

            - name: ğŸ“¦ åˆ›å»ºæœ€ç»ˆZIP
              run: |
                  mv ./docker/frankenphp/docker-compose.yaml ./tmp/a
                  mv ./docker/frankenphp/install.sh ./tmp/a
                  mv ./public ./tmp/a/data/web/public
                  mv ./config ./tmp/a/data/web/config
                  zip -r ${{env.docker_name}}.zip ./tmp/a

            - name: ğŸ“¤ ä¸Šä¼ é•œåƒä¸ºæ„å»ºäº§ç‰©
              uses: actions/upload-artifact@v4
              with:
                  name: ${{env.docker_name}}
                  path: ${{env.docker_name}}.zip
