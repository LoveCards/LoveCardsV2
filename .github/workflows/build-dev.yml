name: build-dev

on:
    # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
    workflow_dispatch:

jobs:
    # è°ƒç”¨ä¸Šæ¸¸ reusable workflow
    Build_AdminFrontEnd:
        uses: LoveCards/v2_frontend_admin/.github/workflows/build-call.yml@main
    Build_Release:
        needs: Build_AdminFrontEnd # ç­‰ä¸Šæ¸¸è·‘å®Œ
        runs-on: ubuntu-latest
        env:
            commit_sha: ${{ github.sha }}

        steps:
            - name: ðŸ¡æ‹‰å–ä»£ç 
              uses: actions/checkout@v3
              with:
                  # â€œæœ€è¿‘æ›´æ–°æ—¶é—´â€ ç­‰ git æ—¥å¿—ç›¸å…³ä¿¡æ¯ï¼Œéœ€è¦æ‹‰å–å…¨éƒ¨æäº¤è®°å½•
                  fetch-depth: 0

            - name: ðŸ’¾ç¼“å­˜ Composer ä¾èµ–
              uses: actions/cache@v3
              with:
                  path: /tmp/composer-cache
                  key: ${{ runner.os }}-${{ hashFiles('**/composer.lock') }}

            - name: ðŸ› ï¸å®‰è£…ä¾èµ–
              uses: php-actions/composer@v6
              with:
                  php_version: "8.1"
                  version: 2

            # ä¸‹è½½ä¸Šæ¸¸ç”Ÿæˆçš„æ‰“åŒ…æ–‡ä»¶
            - name: ðŸ“¥ä¸‹è½½å‰ç«¯ zip
              uses: actions/download-artifact@v4
              with:
                  name: admin # ä¸Žä¸Šæ¸¸ upload-artifact çš„ name ä¸€è‡´
                  path: ./tmp

            #è§£åŽ‹åˆ° ./publicï¼Œå¹¶åŽ»æŽ‰å¤–å±‚ç›®å½•
            - name: ðŸ”“è§£åŽ‹å‰ç«¯åˆ° ./public
              run: |
                mkdir -p public
                unzip -q ./tmp/admin.zip -d ./tmp
                # å¦‚æžœä½ çš„ zip é‡Œé¢æ˜¯ admin/ ç›®å½•ï¼ŒæŠŠå†…å®¹æ¬åˆ° public
                mv ./tmp/admin/* ./public/
                rm -rf ./tmp

            - name: âŒåˆ é™¤éžå¿…è¦æ–‡ä»¶
              run: |
                  rm -rf .gitignore .github .dev ToDo.md .git DOCKER_ENV docker_tag output.log composer.json composer.lock script lock.txt upload.md test.env

            - name: ðŸ·ï¸è®¾ç½®åŽ‹ç¼©åŒ…åç§°
              id: set_zip_name
              run: echo "zip_name=LoveCardsDev-${commit_sha:0:7}.zip" >> $GITHUB_OUTPUT

            - name: ðŸ“¦åŽ‹ç¼©ä¸ºzip
              run: zip -r ${{ steps.set_zip_name.outputs.zip_name }} ./

            - name: ðŸš€ä¸Šä¼ Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.set_zip_name.outputs.zip_name }}
                  path: ${{ steps.set_zip_name.outputs.zip_name }}
                  if-no-files-found: error
